<script>
  const urlParams = new URLSearchParams(window.location.search);
  const productId = urlParams.get('id');

  if (!productId) {
    document.body.innerHTML = "<p style='color:red;'>‚ùå Error: No product ID provided in URL.</p>";
    throw new Error("No product ID in URL");
  }

  let variantMap = {};
  let selectedVariantId = null;
  let basePrice = 19.95;

  const sizeInput = document.getElementById("size");
  const quantityInput = document.getElementById("quantity");

  function updatePriceDisplay() {
    const qty = parseInt(quantityInput.value);
    const total = (basePrice * qty).toFixed(2);
    document.getElementById("productPrice").innerHTML = `<strong>Price:</strong> ¬£${basePrice.toFixed(2)} √ó ${qty} = ¬£${total}`;
  }

  fetch(`https://badger-orders.onrender.com/get-product-details/${productId}`)
    .then(res => res.json())
    .then(data => {
      const result = data?.result?.result || data?.result;

      if (!result || !result.sync_product) {
        document.getElementById("result").innerText = "‚ùå Product not found.";
        return;
      }

      const product = result.sync_product;
      const variants = result.sync_variants || [];

      // Build variant lookup by size (fallback to "M" if no match)
      for (let variant of variants) {
        const sizeLabel = variant.size || "M";
        variantMap[sizeLabel.toUpperCase()] = {
          id: variant.variant_id,
          price: parseFloat(variant.retail_price),
          image: variant.files?.find(f => f.type === "preview")?.preview_url || product.thumbnail_url
        };
      }

      const firstVariant = variants[0];

      // Default: Medium or first variant
      const defaultVariant = variantMap["M"] || {
        id: firstVariant?.variant_id,
        price: parseFloat(firstVariant?.retail_price) || 19.95,
        image: firstVariant?.files?.[0]?.preview_url || product.thumbnail_url
      };

      selectedVariantId = defaultVariant.id;
      basePrice = defaultVariant.price;

      document.getElementById("productImage").src = defaultVariant.image;
      document.getElementById("productName").innerText = product.name;
      updatePriceDisplay();
    })
    .catch(err => {
      document.getElementById("result").innerText = "‚ùå Error loading product: " + err.message;
    });

  // üü® When size changes, update variant selection
  sizeInput.addEventListener("change", () => {
    const chosenSize = sizeInput.value.toUpperCase();
    const variant = variantMap[chosenSize];

    if (variant) {
      selectedVariantId = variant.id;
      basePrice = variant.price;
      document.getElementById("productImage").src = variant.image;
      updatePriceDisplay();
    }
  });

  quantityInput.addEventListener("change", updatePriceDisplay);

  // ‚úÖ Handle order form submission
  document.getElementById("orderForm").addEventListener("submit", function (e) {
    e.preventDefault();

    const payload = {
      name: document.getElementById("name").value,
      email: document.getElementById("email").value,
      address: document.getElementById("address").value,
      city: document.getElementById("city").value,
      size: sizeInput.value,
      quantity: quantityInput.value,
      variant_id: selectedVariantId || "UNKNOWN"
    };

    fetch("https://badger-orders.onrender.com/submit-order", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    })
    .then(res => res.json())
    .then(json => {
      document.getElementById("result").innerText = json.message || "Thank you for your order and support!";
    })
    .catch(err => {
      document.getElementById("result").innerText = "Error: " + err.message;
    });
  });
</script>
