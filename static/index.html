<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Order – Badgers of Bunger Hill</title>
  <style>
#orderForm {
  max-width: 400px; /* Adjust width as needed */
  margin: 0 auto;
  padding: 10px;
  box-sizing: border-box;
}

#orderForm input,
#orderForm select,
#orderForm {
  width: 100%;       /* Make sure it fits parent container */
  max-width: 400px;  /* Or whatever fits your layout */
  padding: 10px;
  box-sizing: border-box;
  overflow: hidden;  /* Prevent overflow */
  margin: 0 auto;    /* Center it */
}

#orderForm textarea {
  width: 100%;
  box-sizing: border-box;
  margin-bottom: 10px;
  padding: 8px;
  font-size: 16px;
  border: 1px solid #ccc;
  border-radius: 4px;
  resize: vertical;
 }
</style>
</head>
<body>

  <img id="productImage" src="" alt="Product Image" />
  <h2 id="productName">Loading...</h2>
  <p id="productPrice"><strong>Price:</strong> Loading...</p>

  <form id="orderForm">
    <input type="text" id="name" placeholder="Your Name" required />
    <input type="email" id="email" placeholder="Your Email" required />
    <textarea id="address" placeholder="Shipping Address" required></textarea>
    <input type="text" id="city" placeholder="City" required />
    <select id="size" required>
      <option value="">Select Size</option>
    </select>
    <select id="quantity" required>
      <option value="1" selected>1</option>
      <option value="2">2</option>
      <option value="3">3</option>
    </select>
    <button type="submit">Buy this product</button>
  </form>

  <div id="result"></div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const urlParams = new URLSearchParams(window.location.search);
  const productId = urlParams.get('id');
  const prefillFields = ["name", "email", "address", "city", "size", "quantity"];

  prefillFields.forEach(field => {
    const input = document.getElementById(field);
    if (input && urlParams.get(field)) {
      input.value = decodeURIComponent(urlParams.get(field));
    }
  });

  const sizeSelect = document.getElementById("size");
  const quantityInput = document.getElementById("quantity");
  let selectedVariantId = null;
  let basePrice = 0;
  const variantMap = {};

  function updatePriceDisplay() {
    const qty = parseInt(quantityInput.value) || 1;
    const total = (basePrice * qty).toFixed(2);
    document.getElementById("productPrice").innerHTML = `<strong>Price:</strong> £${basePrice.toFixed(2)} × ${qty} = £${total}`;
  }

  if (!productId) {
    document.body.innerHTML = "<p style='color:red;'>❌ Error: No product ID provided in URL.</p>";
    return;
  }

  fetch(`https://badger-orders.onrender.com/get-product-details/${productId}`)
    .then(res => res.json())
    .then(data => {
      const result = data?.result?.result || data?.result;
      if (!result?.sync_product) {
        document.getElementById("result").innerText = "❌ Product not found.";
        return;
      }

      const product = result.sync_product;
      const variants = result.sync_variants || [];

      // Set product image (default)
      let imageUrl = product.thumbnail_url || "";
      if (variants.length === 1 && variants[0].files?.length > 0) {
        imageUrl = variants[0].files.find(f => f.type === "preview")?.preview_url || imageUrl;
        selectedVariantId = productId;
      }
      document.getElementById("productImage").src = imageUrl;
      document.getElementById("productName").innerText = product.name;

      if (variants.length === 0) {
        // NO variants — disable size select and prefill size from URL or default
        const sizeFromUrl = urlParams.get("size") || "Default Size";
        sizeSelect.innerHTML = `<option value="${sizeFromUrl}" selected>${sizeFromUrl}</option>`;
        sizeSelect.disabled = true;

        // No variant ID available; set to original product ID or handle accordingly
        selectedVariantId = productId;

        // Use fallback price or from product if available
        basePrice = product.retail_price ? parseFloat(product.retail_price) : 0;
        updatePriceDisplay();

      } else {
        // Variants exist — enable size select and populate options
        sizeSelect.disabled = false;
        sizeSelect.innerHTML = '<option value="">Select Size</option>';
        for (const variant of variants) {
          const size = variant.size || "M";
          variantMap[size.toUpperCase()] = {
            id: variant.variant_id,
            price: parseFloat(variant.retail_price),
            image: variant.files?.find(f => f.type === "preview")?.preview_url || imageUrl
          };
          sizeSelect.innerHTML += `<option value="${size.toUpperCase()}">${size}</option>`;
        }

        // Handle variant selection changes
        sizeSelect.addEventListener("change", () => {
          const selectedSize = sizeSelect.value;
          if (variantMap[selectedSize]) {
            const variant = variantMap[selectedSize];
            selectedVariantId = variant.id;
            basePrice = variant.price;
            document.getElementById("productImage").src = variant.image;
            updatePriceDisplay();
          }
        });

        // Auto-select size if prefilled in URL
        const prefilledSize = urlParams.get("size");
        if (prefilledSize && variantMap[prefilledSize.toUpperCase()]) {
          sizeSelect.value = prefilledSize.toUpperCase();
          const event = new Event("change");
          sizeSelect.dispatchEvent(event);
        }
      }
    })
    .catch(err => {
      document.getElementById("result").innerText = "❌ Error loading product: " + err.message;
    });

  quantityInput.addEventListener("change", updatePriceDisplay);

  document.getElementById("orderForm").addEventListener("submit", async function (e) {
    e.preventDefault();

    const payload = {
      name: document.getElementById("name").value,
      email: document.getElementById("email").value,
      address: document.getElementById("address").value,
      city: document.getElementById("city").value,
      size: sizeSelect.value || "N/A",
      quantity: quantityInput.value,
      variant_id: selectedVariantId || "UNKNOWN"
    };

    try {
      const response = await fetch('https://badger-orders.onrender.com/submit-order', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (!response.ok) {
         const errorBody = await response.json();
         const reason = errorBody?.error || "Order submission failed";
         throw new Error(reason);
      } 
      const result = await response.json();

      if (result.stripe_link) {
        window.location.href = result.stripe_link;
      } else if (result.revolut_link) {
        window.location.href = result.revolut_link;
      } else {
        document.getElementById("result").innerText = "✅ Order submitted successfully!";
      }

    } catch (error) {
      document.getElementById("result").innerText = "❌ Error submitting order: " + error.message;
    }
  });
});
</script>

</body>
</html>
