<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Product Order - 2025-07-18</title>
</head>
<body>
  <h1 id="productName">Loading…</h1>
  <img id="productImage" src="" alt="Product image" width="200"/><br>
  <select id="size"></select><br>
  <div id="productPrice"></div>
  Quantity: <input id="quantity" type="number" value="1" min="1"/><br><br>
  <button id="buy-button">Buy</button>
  <p id="result"></p>

  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const params     = new URLSearchParams(window.location.search);
      const productId  = params.get('id') || '386786171';

      // Fetch and render product details
      const res  = await fetch(`/get-product-details/${productId}`);
      const data = await res.json();
      const result = data.result;
      if (!result) {
        document.getElementById("result").innerText = "❌ Product not found.";
        return;
      }
      document.getElementById("productName").innerText = result.sync_product?.name || result.product?.name;

      let img = result.sync_product?.thumbnail_url || result.product?.thumbnail_url || "";
      if (result.sync_variants?.length === 1) {
        const preview = result.sync_variants[0].files.find(f => f.type==="preview");
        if (preview) img = preview.preview_url;
      }
      document.getElementById("productImage").src = img;

      // Populate sizes
      const variants = result.sync_variants || result.variants || [];
      const sizeSelect = document.getElementById("size");
      if (variants.length === 1) {
        const v = variants[0];
        const label = v.size || "10 L";
        sizeSelect.innerHTML = `<option>${label}</option>`;
        sizeSelect.disabled = true;
      } else {
        sizeSelect.innerHTML = '<option value="">Select Size</option>';
        variants.forEach(v => {
          const label = v.size || v.name || "N/A";
          sizeSelect.innerHTML += `<option value="${label}">${label}</option>`;
        });
      }

      // Price display helper
      let basePrice = variants.length === 1
        ? parseFloat(variants[0].retail_price || 0)
        : parseFloat(variants[0]?.retail_price || 0);
      const updatePrice = () => {
        const qty = parseInt(document.getElementById("quantity").value,10)||1;
        document.getElementById("productPrice").innerHTML =
          `£${(basePrice*qty).toFixed(2)}`;
      };
      document.getElementById("quantity").addEventListener("input", updatePrice);
      updatePrice();

      // Buy button
      document.getElementById("buy-button").onclick = async () => {
        const qty  = parseInt(document.getElementById("quantity").value,10)||1;
        const size = sizeSelect.value;
        const cost = Math.round(basePrice * qty * 100);
        const body = { product_id: productId, variant_id: variants.find(v=>v.size===size)?.variant_id, quantity: qty, cost };

        const orderRes = await fetch('/submit-order', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(body)
        });
        const js = await orderRes.json();
        if (orderRes.ok) {
          window.location = js.stripe_link;
        } else {
          document.getElementById("result").innerText = js.error || 'Order failed';
        }
      };
    });
  </script>
</body>
</html>
